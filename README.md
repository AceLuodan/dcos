# DC/OS修炼之路

在这个“移动为先，云为先”的时代，一切的技术，架构都以Cloud Native为衡量标准。在这样的环境下，如何快速构建可靠的大规模应用集群，成为大家关注的一个焦点。本书既是作者以微服务、容器和数据中心操作系统为基石快速构建大规模应用集群的实践总结，也是一本关于DC/OS的修炼之书，记录了一次新的探索旅程。

俗话说，聚沙成塔，又说，一沙一世界。在软件开发人员的世界中，一个软件应用可以从一体两面进行分析：技术和业务。软件的粒度在微观和宏观两个方向延伸，不同的粒度层面代表着不一样的思考纬度。  
![](/assets/docker_soft_granularity.png)

在技术方向上，随着软硬件技术的不断发展，信息技术在生产活动中的不断深化应用，技术实践积累不断提高，技术抽象不断完善， 技术关注点的层次也不断提高。

从最初的二进制指令，经过抽象提升到汇编、IL，再进一步到达了过程、方法和数据结构； 随着抽象层次继续提升，粒度继续放大，发展到基于类抽象和接口定义契约的面向对象层面，人们总结出各种设计模式； 在开始面向组件，服务的设计建模时，EJB、Spring框架/IOC容器、SOA服务等技术体系出现并主导这一层面。

这一切看上去阐述的很粗糙，但从中仍可以看到，领域研究的粒度是不断放大的，随着某一层次的研究经过长时间的实践积累，量变引发质变，就开始 向更高一层进行突破，新的技术开始出现，而容器技术，正是可以看做是又一次质变的结果。

移动互联网的飞速发展使得移动APP成为业务交互的入口，海量数据跨越时空限制，被互联网高速公路快速汇集， 单一系统的服务再也无法满足处理性能要求，人们开始寻找新的替代方案，在不断的探索，研究，实践和修正过程中，分布式集群、微服务设计理论与实践逐渐成熟，云计算、大数据处理开始主导当前技术潮流，这也成为容器技术得以成长的土壤。

### 微服务

业务系统随着单机应用，内部互联到INTERNET，移动互联，单一进程中承载所有功能的技术架构被复杂度，可维护性和海量用户带来的负载压力所击溃。应对之法就是拆分，如何拆分，何处着手，怎么控制，带来哪些新的问题，下面我们从一个典型的应用系统进行分析。

![](/assets/microservice_app_overview.png)

上图是一个典型的应用系统，它通常需要为用户提供外部访问接口，处理内部各种业务逻辑，将数据存储到数据库系统，在处理业务的过程中，系统可能需要与第三方系统或设备交换数据，并且为管理用户提供WEB管理入口。

如何对上述应用系统进行拆分？通常典型的方法是按业务功能。当然，既可以纵向拆分也可以横向拆分，或者两者结合。在实践过程中，仍需要结合项目实际情况具体把握。

下图是按功能拆分微服务后的系统结构图，从图上可以看出，基于微服务的新系统功能模块结构清晰，但额外引入了服务间调用的复杂性，同时，也需要一个新的API Gateway来聚合对外提供服务的接口。
![](/assets/microservice_ms_overview.png)

微服务真的如此简单？答案当然不是。一种新的解决方案需要在各个层面，各个角度做出权衡和决策，下面我们以一个服务单元为视角，看一下需要面对哪些问题：

![](/assets/microservice_service_unit.png)

如图中所示，对于一个微服务实例，我们至少需要考虑以下问题：

* 接口如何定义？采用REST还是其他？

* 采用何种通信模型？RPC，消息，同步/异步，响应式还是事件驱动？

* 服务是按何种粒度切分的？纵向，横向，有无其他更好的方案？

* 服务如何被调用？其他服务如何发现此服务的存在？内部服务和外部服务如何区分？

* 服务处理的数据如何存储？

* 服务如何部署？单实例，多实例，如何支持负载均衡？

* 服务如何治理？是否公开了测量指标，怎么监控这些指标？日志是否需要归集？如何控制服务的安全？

针对这些问题，每一个都有多种不同的候选方案，此处不再展开详细的探讨。

### 容器

传统的单进程应用系统在部署时通常会独占物理主机的所有硬件资源。在应用系统被拆分成微服务后，单个服务占用整机物理资源会造成很大的闲置浪费，一种方案是通过虚拟机进行隔离，当部署数十甚至上百个虚拟机时，虚拟机本身的资源消耗也会造成巨大的资源浪费。



![](/assets/microservice_resource_docker.png)
### DC/OS
![](/assets/microservice_overlay.png)
![](/assets/ms-cluster-4.png)

DC/OS即数据中心操作系统，是一个架构于现有单机操作系统之上为上层应用提供CPU、内存、磁盘和网络等规模化集群资源的分配调度的分布式操作系统。DC/OS是Mesos、Marathon、Docker及其它相关技术的一个框架整合，适用于快速构建大规模异构应用集群。